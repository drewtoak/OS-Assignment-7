/*
 * This is sample code generated by rpcgen.
 * These are only templates and you can use them
 * as a guideline for developing your own functions.
 */

#include "rpc.h"
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <string.h>

#define MESSAGE_LEN 10

char *generate_str();
void _funcget();
void _funcput();

CLIENT *clnt;
char *host;

int main (int argc, char *argv[]) {
	if (argc < 2) {
		printf ("usage: %s server_host\n", argv[0]);
		exit (1);
	}

	host = argv[1];
	clnt = clnt_create(host, RPC_PROG, RPC_VER, "tcp");
	if (clnt == (CLIENT *) NULL) {
		clnt_pcreateerror(host);
		exit(EXIT_FAILURE);
	}

	int identifier = getpid();
	printf("Client ID : %d.\n", identifier);
	int ret_num;
	struct message test;

	int i = 0;
	while (i < 5) {
		char *message = generate_str();
		strcpy(test.content, message);
		test.ID = identifier;

		ret_num = *put_1(&test, clnt);
		if (ret_num == -1) {
			perror("Error putting message on server!");
			exit(EXIT_FAILURE);
		}

		printf("Put returned %d\n", ret_num);
		i++;
		sleep(1);
	}

	sleep(5);

	struct response *ret_val;
	i = 0;
	while (i < 10) {
		ret_val = get_1(&identifier, clnt);
		if (ret_val->status_code == -1) {
			perror("Error got an empty message!");
			exit(EXIT_FAILURE);
		}
		printf("Got message: %s.\n", ret_val->content);
		i++;
		sleep(1);
	}

	exit (0);
}

char *generate_str() {
 	const char charset[] = "abcdefghijklmnopqrstuvwxyz";

	size_t size = MESSAGE_LEN - 1;
	char *randomstr = malloc(sizeof(char) * (size + 1));

	size_t i;
	for (i = 0; i < size; i++) {
		int key = rand() % (int) (sizeof(charset) - 1);
		randomstr[i] = charset[key];
	}
	randomstr[size] = '\0';

	return randomstr;
}
